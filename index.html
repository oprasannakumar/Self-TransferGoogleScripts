<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Self Transfer (Queue Count)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#f3f6fb;
  --card:#ffffff;
  --text:#1f2937;
  --muted:#6b7280;
  --border:#e5e7eb;
  --primary:#2563eb;
  --primary-dark:#1e40af;
  --cash:#f9fafb;
}

body{
  margin:0;
  font-family:"Segoe UI", Arial, sans-serif;
  background:var(--bg);
  padding:20px;
  color:var(--text);
}

form{
  max-width:440px;
  margin:auto;
  background:var(--card);
  padding:24px;
  border-radius:16px;
  box-shadow:0 20px 40px rgba(0,0,0,.08);
}

h2{text-align:center;margin:0 0 16px;font-weight:600}
h3{margin:18px 0 8px;font-size:15px;color:var(--primary)}

label{
  font-size:13px;
  font-weight:600;
  margin-top:12px;
  display:block;
  color:var(--muted);
}

input,select,textarea,button{
  width:100%;
  height:44px;
  margin-top:6px;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  box-sizing:border-box;
  font-size:14px;
  background:#fff;
}

textarea{height:44px;resize:none}

input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 2px rgba(37,99,235,.15);
}

hr{
  border:none;
  border-top:1px dashed var(--border);
  margin:20px 0;
}

button{
  margin-top:20px;
  background:var(--primary);
  color:#fff;
  border:none;
  font-weight:600;
  cursor:pointer;
}
button:hover{background:var(--primary-dark)}
button:disabled { opacity: 0.6; cursor: not-allowed; }

.amount-cash{background:var(--cash);font-weight:600}

/* Cash box */
#cashBox{
  margin-top:14px;
  background:var(--cash);
  padding:14px;
  border-radius:14px;
  border:1px solid var(--border);
}

#denominations{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin-top:10px;
}

.denom-card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  text-align:center;
  font-weight:600;
  background:#fff;
}

.denom-card input{
  margin-top:6px;
  height:36px;
  text-align:center;
  font-weight:600;
}

/* Sync Indicator Styles */
#syncStatus {
  margin-top: 15px;
  padding: 12px;
  border-radius: 8px;
  font-size: 13px;
  text-align: center;
  font-weight: 500;
  display: none;
}
.sync-pending { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
.sync-success { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
.sync-progress { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }

/* ===== Mobile dropdown fix ===== */
select{
  background-color:#ffffff !important;
  color:#111827;
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
  background-image:
    linear-gradient(45deg, transparent 50%, #6b7280 50%),
    linear-gradient(135deg, #6b7280 50%, transparent 50%);
  background-position:
    calc(100% - 20px) 18px,
    calc(100% - 15px) 18px;
  background-size:5px 5px,5px 5px;
  background-repeat:no-repeat;
}

select::-ms-expand{display:none}

select:disabled{
  background-color:#ffffff !important;
  color:#6b7280;
}

select:focus{
  background-color:#ffffff !important;
}

/* ===== Mobile DATE input fix ===== */
input[type="date"]{
  background-color:#ffffff !important;
  color:#111827;
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
}

input[type="date"]::-webkit-date-and-time-value{
  color:#111827;
}

input[type="date"]:focus{
  background-color:#ffffff !important;
}

input[type="date"]:disabled{
  background-color:#ffffff !important;
  color:#6b7280;
}

/* ===== DARK MODE ===== */
body.dark{
  --bg:#020617;
  --card:#020617;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --border:#334155;
  --primary:#6366f1;
  --primary-dark:#4f46e5;
  --cash:#020617;
}
.amount-cash.negative{
  color:#dc2626;
  font-weight:700;
}

body.dark{
  background:var(--bg);
  color:var(--text);
}

body.dark form{
  background:var(--card);
}

body.dark h2,
body.dark h3,
body.dark label{
  color:var(--text);
}

body.dark input,
body.dark select,
body.dark textarea{
  background-color:#020617 !important;
  color:#e5e7eb !important;
  border-color:var(--border);
}

body.dark input::placeholder,
body.dark textarea::placeholder{
  color:#94a3b8;
}

body.dark input:focus,
body.dark select:focus,
body.dark textarea:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 2px rgba(99,102,241,.25);
}

/* Date text */
body.dark input[type="date"]::-webkit-date-and-time-value{
  color:#e5e7eb;
}

.error-text{
  font-size:12px;
  color:#dc2626;
  margin-top:4px;
  display:none;
}

/* Dropdown arrow dark */
body.dark select{
  background-image:
    linear-gradient(45deg, transparent 50%, #9ca3af 50%),
    linear-gradient(135deg, #9ca3af 50%, transparent 50%);
}
</style>
</head>

<body>

<form id="form">
<h2>Self Transfer</h2>

<label>Date</label>
<input type="date" id="date">
<div class="error-text" id="dateErr"></div>

<label>Narration</label>
<textarea id="narration" placeholder="Enter narration"></textarea>
<div class="error-text" id="narrationErr"></div>
<hr>

<h3>From</h3>
<label>Transaction Type</label>
<select id="fromType">
  <option value="">Select</option>
  <option>Cash</option>
  <option>Upi</option>
  <option>Debit</option>
  <option>Net</option>
  <option>Credit</option>
</select>
<div class="error-text" id="fromTypeErr"></div>

<label id="fromAccLabel" style="display:none">Account</label>
<select id="fromAccount" style="display:none"></select>
<div class="error-text" id="fromAccErr"></div>
<hr>

<h3>To</h3>
<label>Transaction Type</label>
<select id="toType">
  <option value="">Select</option>
  <option>Cash</option>
  <option>Upi</option>
  <option>Debit</option>
  <option>Net</option>
  <option>Credit</option>
</select>
<div class="error-text" id="toTypeErr"></div>

<label id="toAccLabel" style="display:none">Account</label>
<select id="toAccount" style="display:none"></select>
<div class="error-text" id="toAccErr"></div>
<hr>

<div id="cashBox" style="display:none">
<h3>Cash Denominations</h3>
<div id="denominations"></div>
</div>

<label>Amount</label>
<input type="number" id="amount" step="0.01" inputmode="decimal">
<div class="error-text" id="amountErr"></div>

<button type="submit">Submit</button>

<div id="syncStatus"></div>
</form>

<script>
/* âš ï¸ YOUR SCRIPT URL */
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbyCOPRvcR2dQamCJa-2K_ap8AhDlInXA_cbttY55NTdp3Q8YHUhD1j9lRfTaLQRpu5p/exec";

let isSubmitting = false;
const submitBtn = document.querySelector('#form button[type="submit"]');

/* ===== 1. INDEXED DB SETUP (OFFLINE STORAGE) ===== */
const DB_NAME = "SelfTransferDB";
const STORE_NAME = "transferQueue";
let db;

const initDB = () => {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, 1);
    
    request.onupgradeneeded = (event) => {
      db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
      }
    };

    request.onsuccess = (event) => {
      db = event.target.result;
      resolve(db);
      checkPendingSync(); // Check for pending items on load
    };

    request.onerror = (event) => {
      console.error("DB Error", event);
      reject("DB Error");
    };
  });
};

const saveToQueue = (data) => {
  if(!db) return;
  const transaction = db.transaction([STORE_NAME], "readwrite");
  const store = transaction.objectStore(STORE_NAME);
  store.add(data);
  
  // After saving, immediately check count to update UI
  transaction.oncomplete = () => {
    checkPendingSync(); 
  };
};

const getQueue = () => {
  return new Promise((resolve) => {
    const transaction = db.transaction([STORE_NAME], "readonly");
    const store = transaction.objectStore(STORE_NAME);
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result);
  });
};

const clearItem = (id) => {
  const transaction = db.transaction([STORE_NAME], "readwrite");
  const store = transaction.objectStore(STORE_NAME);
  store.delete(id);
};

/* ===== 2. SYNC LOGIC (WITH COUNT) ===== */
const syncStatusDiv = document.getElementById("syncStatus");

function updateSyncStatus(type, msg) {
  syncStatusDiv.style.display = "block";
  syncStatusDiv.className = ""; // clear classes
  syncStatusDiv.textContent = msg;
  
  if (type === "pending") syncStatusDiv.classList.add("sync-pending");
  if (type === "progress") syncStatusDiv.classList.add("sync-progress");
  if (type === "success") syncStatusDiv.classList.add("sync-success");
}

async function checkPendingSync() {
  const queue = await getQueue();
  const count = queue.length;

  if (count > 0) {
    if (navigator.onLine) {
      processQueue(queue);
    } else {
      // âš ï¸ SHOW COUNT HERE
      updateSyncStatus("pending", `âš ï¸ ${count} transfer${count > 1 ? 's' : ''} waiting for network.`);
    }
  } else {
    syncStatusDiv.style.display = "none";
  }
}

async function processQueue(queue) {
  const count = queue.length;
  updateSyncStatus("progress", `ðŸ”„ Syncing ${count} pending item${count > 1 ? 's' : ''}...`);
  
  for (const item of queue) {
    try {
      await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(item)
      });
      // If successful, remove from DB
      clearItem(item.id);
    } catch (error) {
      console.error("Sync failed for item", item, error);
      // Update status to show it failed but still pending
      const remaining = await getQueue();
      updateSyncStatus("pending", `âš ï¸ Network error. ${remaining.length} items pending.`);
      return; 
    }
  }
  
  // Check remaining
  const remaining = await getQueue();
  if (remaining.length === 0) {
    updateSyncStatus("success", "âœ… All offline data synced successfully!");
    setTimeout(() => syncStatusDiv.style.display = "none", 3000);
  }
}

// Listen for network restoration
window.addEventListener('online', checkPendingSync);

// Init DB on load
initDB();

/* ===== 3. FORM UI & LOGIC ===== */
const date = document.getElementById("date");
const narration = document.getElementById("narration");
const fromType = document.getElementById("fromType");
const fromAccount = document.getElementById("fromAccount");
const fromAccLabel = document.getElementById("fromAccLabel");
const toType = document.getElementById("toType");
const toAccount = document.getElementById("toAccount");
const toAccLabel = document.getElementById("toAccLabel");
const cashBox = document.getElementById("cashBox");
const amount = document.getElementById("amount");
const denDiv = document.getElementById("denominations");
const form = document.getElementById("form");

date.value = new Date().toISOString().split("T")[0];

const bankAccounts=["FI","HDFC Old","HDFC New","ICICI","IndusInd","Kotak","RBL","SBI"];
const creditCards=[
 "Axis Flipkart","Axis MyZone","Axis Neo",
 "HDFC PhonePe","HDFC Tata Neu","HDFC Millennia",
 "HSBC","IDFC First Millenia","ICICI Amazon",
 "ICICI Coral","ICICI Expressions","Indusind Plat Aura EDGE",
 "Indusind Legend","Yes Finbooster","Kotak League",
 "Kotak Image","SBI BPCL","Standard Chartered"
];

const denoms=[500,200,100,50,20,10,5,2,1];

denoms.forEach(d=>{
  denDiv.innerHTML+=`
    <div class="denom-card">
      â‚¹${d}<br>
     <input type="number" step="1" data-d="${d}" value="0">
    </div>`;
});

function buildAccounts(type, acc, label){
  acc.innerHTML="";
  if(type==="Cash" || !type){
    acc.style.display="none";
    label.style.display="none";
    return;
  }
  const list = type==="Credit" ? creditCards : bankAccounts;
  acc.innerHTML="<option value=''>Select</option>";
  list.forEach(v=>acc.innerHTML+=`<option>${v}</option>`);
  acc.style.display="block";
  label.style.display="block";
}

function handleCash(){
  const isCash = fromType.value==="Cash" || toType.value==="Cash";
  cashBox.style.display=isCash?"block":"none";
  amount.readOnly=isCash;
  amount.classList.toggle("amount-cash",isCash);

  if(!isCash){
    amount.value="";
    document.querySelectorAll("[data-d]").forEach(i=>i.value=0);
  }
}

document.addEventListener("input",e=>{
  if(e.target.dataset?.d){
    let total=0;
    document.querySelectorAll("[data-d]").forEach(i=>{
      total+=Number(i.dataset.d)*Number(i.value||0);
    });
    amount.value=total;
    amount.classList.toggle("negative", Number(amount.value) < 0);
  }
});

fromType.onchange=()=>{buildAccounts(fromType.value,fromAccount,fromAccLabel);handleCash();}
toType.onchange=()=>{buildAccounts(toType.value,toAccount,toAccLabel);handleCash();}

function getDenominations(){
  const d = {};
  document.querySelectorAll("[data-d]").forEach(i => {
    const val = Number(i.value);
    if (val !== 0) {
      d[i.dataset.d] = val;
    }
  });
  return d;
}

function showErr(id, msg){
  const el = document.getElementById(id);
  el.textContent = msg;
  el.style.display = "block";
}

function clearErr(id){
  const el = document.getElementById(id);
  el.textContent = "";
  el.style.display = "none";
}

function validateForm(){
  let valid = true;

  clearErr("dateErr");
  clearErr("narrationErr");
  clearErr("fromTypeErr");
  clearErr("fromAccErr");
  clearErr("toTypeErr");
  clearErr("toAccErr");
  clearErr("amountErr");

  if(!date.value){
    showErr("dateErr","Date is required");
    valid = false;
  }

  if(!narration.value.trim()){
    showErr("narrationErr","Narration is required");
    valid = false;
  }

  if(!fromType.value){
    showErr("fromTypeErr","Select transaction type");
    valid = false;
  }

  if(fromType.value && fromType.value !== "Cash" && !fromAccount.value){
    showErr("fromAccErr","Select account");
    valid = false;
  }

  if(!toType.value){
    showErr("toTypeErr","Select transaction type");
    valid = false;
  }

  if(toType.value && toType.value !== "Cash" && !toAccount.value){
    showErr("toAccErr","Select account");
    valid = false;
  }

  if(Number(amount.value) <= 0){
    showErr("amountErr","Amount must be greater than 0");
    valid = false;
  }

  if(
    fromType.value &&
    toType.value &&
    fromType.value === toType.value &&
    fromAccount.value === toAccount.value
  ){
    showErr("toAccErr","From and To cannot be same");
    valid = false;
  }

  return valid;
}

document.addEventListener("input", e=>{
  const map = {
    date:"dateErr",
    narration:"narrationErr",
    fromType:"fromTypeErr",
    fromAccount:"fromAccErr",
    toType:"toTypeErr",
    toAccount:"toAccErr",
    amount:"amountErr"
  };
  if(map[e.target.id]) clearErr(map[e.target.id]);
});

/* ===== 4. SUBMIT HANDLER ===== */
form.onsubmit = async e => {
  e.preventDefault();

  if(!validateForm()) return;
  if (isSubmitting) return;

  // CONSTRUCT PAYLOAD
  const payload = {
    date: date.value,
    narration: narration.value,
    fromType: fromType.value,
    fromAccount: fromType.value === "Cash" ? "Cash" : fromAccount.value,
    toType: toType.value,
    toAccount: toType.value === "Cash" ? "Cash" : toAccount.value,
    amount: Number(amount.value || 0),
    denominations: getDenominations()
  };

  isSubmitting = true;
  submitBtn.disabled = true;
  submitBtn.textContent = "Processing...";

  const resetFormUI = () => {
    form.reset();
    date.value = new Date().toISOString().split("T")[0];
    cashBox.style.display = "none";
    amount.classList.remove("amount-cash");
    document.querySelectorAll("[data-d]").forEach(i => i.value = 0);
  };

  // LOGIC SPLIT: ONLINE vs OFFLINE
  if (!navigator.onLine) {
    // Offline
    saveToQueue(payload);
    // Note: checkPendingSync is called inside saveToQueue
    resetFormUI();
    resetSubmitState();
  } else {
    // Online
    try {
      const r = await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      });
      
      if (!r.ok) throw new Error("Network error");
      await r.text(); 
      
      alert("Self transfer saved");
      resetFormUI();
      
    } catch (err) {
      console.error("Online submit failed", err);
      // Fallback to offline save
      saveToQueue(payload);
      alert("âŒ Connection unstable.\nSaved offline.");
      resetFormUI();
    } finally {
      resetSubmitState();
    }
  }
};

function resetSubmitState() {
  isSubmitting = false;
  submitBtn.disabled = false;
  submitBtn.textContent = "Submit";
}

/* Double Tap Theme Toggle */
let lastTap = 0;
const selfForm = document.getElementById("form");

selfForm.addEventListener("click", () => {
  const now = Date.now();
  if (now - lastTap < 300) {
    document.body.classList.toggle("dark");
  }
  lastTap = now;
});
</script>

</body>
</html>
