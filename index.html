<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Self Transfer | Smart Sync Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

    :root { 
      --primary:#2563eb; 
      --primary-hover:#1e40af; 
      --secondary: #10b981;
      --danger:#ef4444; 
      --bg-body: linear-gradient(135deg, #eef2f7, #f9fafb);
      --bg-card: #ffffff;
      --text-main: #111827;
      --text-label: #374151;
      --border-color: #d1d5db;
      --bg-input: #ffffff;
      --btn-h: 44px; 
    }

    body.dark { 
      --bg-body: #020617; 
      --bg-card: #0f172a;
      --text-main: #f9fafb;
      --text-label: #94a3b8;
      --border-color: #334155;
      --bg-input: #1e293b;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      padding: 20px; margin: 0; min-height: 100vh;
      transition: background 0.5s ease, color 0.5s ease;
    }

    form, .confirm-card {
      background: var(--bg-card); max-width: 440px; margin: auto; padding: 22px;
      border-radius: 16px; box-shadow: 0 18px 40px rgba(0,0,0,.08);
      border: 1px solid var(--border-color);
      position: relative;
      transition: background 0.5s ease, border-color 0.5s ease;
    }

    .confirm-card { max-width: 550px; width: 90%; }

    .header-row-top {
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 20px; position: relative; min-height: 32px;
    }

    h2 { margin: 0; font-weight: 600; color: var(--text-main); font-size: 20px; text-align: center; }

    #statusDot { 
      position: absolute; left: 0; width: 12px; height: 12px; 
      border-radius: 50%; background: #94a3b8; transition: 0.3s;
    }
    #statusDot.online { background: #10b981; box-shadow: 0 0 10px #10b981; }
    #statusDot.offline { background: var(--danger); box-shadow: 0 0 10px var(--danger); }

    .header-actions { position: absolute; right: 0; display: flex; gap: 8px; align-items: center; }

    #themeToggle, #fabToggle { 
      width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border-color); 
      background: var(--bg-input); color: var(--text-main); cursor: pointer; 
      display: flex; align-items: center; justify-content: center; 
      font-size: 14px; padding: 0; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); flex-shrink: 0;
    }
    .theme-rotate { transform: rotate(360deg); }
    .nav-fab-container { position: relative; }
    .nav-options { 
      position: absolute; right: 0; top: 40px; display: flex; flex-direction: column; 
      align-items: flex-end; gap: 8px; opacity: 0; transform: translateY(-10px); 
      pointer-events: none; transition: 0.2s ease-out; z-index: 10001; 
    }
    .nav-fab-container.active .nav-options { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .nav-item { 
      background: var(--bg-card); color: var(--text-main); padding: 8px 14px; 
      border-radius: 10px; font-size: 12px; font-weight: 600; text-decoration: none; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid var(--border-color); 
      white-space: nowrap; width: fit-content; transition: background 0.5s ease;
    }
    .nav-item:hover { background: var(--primary); color: white; border-color: var(--primary); }

    .batch-control { display: flex; align-items: center; justify-content: space-between; background: rgba( 99,102,241,0.1); padding: 8px 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #22c55e; height:25px; }
    .switch { position: relative; display: inline-block; width: 40px; height: 22px; margin-top:0px}
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #22c55e; }
    input:checked + .slider:before { transform: translateX(18px); }

    h3 { margin: 18px 0 8px; font-size: 14px; color: #22c55e; text-transform: uppercase; letter-spacing: 0.05em; }
    label { font-size: 13px; font-weight: 600; margin-top: 14px; display: block; color: var(--text-label); }

    input, select, button {
      width: 100%; height: 44px; margin-top: 6px; padding: 0 14px;
      border-radius: 10px; border: 1px solid var(--border-color); font-size: 14px; box-sizing: border-box;
      background: var(--bg-input); color: var(--text-main); transition: all 0.3s ease;
    }

    input:focus, select:focus { 
      outline: none; 
      border-color: #22c55e; 
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15); 
    }

    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 25px; }

    #submitBtn, .btn-confirm, #btnSyncAll, #btnViewQueue, #btnRepeat, .btn-cancel, #btnStopSync { 
      height: var(--btn-h); font-weight: 600; border-radius: 10px; font-size: 14px; 
      cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; padding: 0 10px;
    }

    #submitBtn, .btn-confirm { background: var(--primary); color: #fff; border: none; }
    #btnRepeat, .btn-cancel { background: var(--bg-input); color: var(--text-main); border: 1.5px solid var(--border-color); }
    #btnStopSync { border: 1.5px solid #ef4444; background-color: white; color: #ef4444; }

    hr { border: none; border-top: 1px dashed var(--border-color); margin: 20px 0; }
    .hidden { display: none !important; }

    #cashBox { margin-top: 14px; background: var(--bg-body); padding: 14px; border-radius: 14px; border: 1px solid var(--border-color); }
    #denominations, .confirm-matrix { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .denom-card, .matrix-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 10px 5px; text-align: center; }
    .denom-label, .matrix-label { font-weight: 600; margin-bottom: 5px; font-size: 11px; color: var(--text-label); }
    .denom-card input { height: 32px; text-align: center; margin-top: 0; border-radius: 6px; width: 80%; }

    .sync-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px dashed var(--border-color); }
    #btnSyncAll { background: var(--secondary); color: white; border: none; gap: 6px; }
    #btnViewQueue { background: #94a3b8; color: white; border: none; }

    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 10px; box-sizing: border-box; }
    .modal-content { background: var(--bg-card); color: var(--text-main); width: 95%; max-width: 850px; max-height: 85vh; border-radius: 14px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border-color); }
    
    .confirm-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 13px; }
    .confirm-label { font-weight: 600; color: var(--text-label); }
    .confirm-val { color: var(--text-main); text-align: right; font-weight: 500; }
    .confirm-section-title { font-size: 12px; font-weight: 700; color: var(--primary); margin: 15px 0 8px 0; text-transform: uppercase; border-bottom: 1px solid var(--primary); width: fit-content; padding-right: 10px; }

    .table-container { overflow-x: auto; flex-grow: 1; background: var(--bg-card); }
    table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 900px; table-layout: fixed; }
    th { text-align: center; padding: 8px; border-bottom: 2px solid var(--border-color); color: var(--text-label); }
    td { padding: 10px 5px; border-bottom: 1px solid var(--border-color); vertical-align: middle; text-align: center; color: var(--text-main); }

    .action-btn { border: none; width: 34px; height: 34px; border-radius: 10px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin: 0 4px; }
    .btn-del-mini { background: #fee2e2; color: #ef4444; }
    .btn-edit-mini { background: #e0e7ff; color: #4338ca; }

    .queue-denoms { font-size: 9.5px; color: #2563eb; font-family: monospace; display: block; line-height: 1.2; margin-top: 4px; opacity: 0.8; word-wrap: break-word; }

    .modal-header { 
      display: flex; justify-content: space-between; align-items: center; 
      border-bottom: 1px solid var(--border-color); padding: 15px 20px; background: var(--bg-card);
    }
    .close-modal { font-size: 28px; font-weight: bold; cursor: pointer; color: var(--text-label); line-height: 1; padding: 5px; }
  </style>
</head>

<body>

<form id="form" novalidate>
  <div class="header-row-top">
    <div id="statusDot" title="Network Status"></div>
    <h2>Self Transfer</h2>
    
    <div class="header-actions">
      <div class="nav-fab-container" id="navFab">
        <button type="button" id="fabToggle" title="Navigation">üîó</button>
        <div class="nav-options">
          <a href="https://oprasannakumar.github.io/MonthlytransactionsGoogleSheets/" class="nav-item">üîÑ Monthly Transaction</a>
          <a href="https://oprasannakumar.github.io/LoanTransferGoogleSheets/" class="nav-item">üè¶ Loan Entry</a>
        </div>
      </div>
      <button type="button" id="themeToggle" title="Toggle Dark Mode">üåô</button>
    </div>
  </div>

  <div class="batch-control">
    <span style="font-size: 12px; font-weight: 600;">Batch Mode</span>
    <label class="switch">
      <input type="checkbox" id="batchToggle">
      <span class="slider"></span>
    </label>
  </div>

  <label>Date</label>
  <input type="date" id="date" required>

  <label>Narration</label>
  <input type="text" id="narration" required placeholder="What is this transfer for?">

  <hr>
  <h3>From</h3>
  <label>Transaction Type</label>
  <select id="fromType" required>
    <option value="">Select</option>
    <option>Cash</option><option>Upi</option><option>Debit</option><option>Net</option><option>Credit</option><option>Rewards</option>
  </select>

  <div id="fromAccBlock" class="hidden">
    <label>Source Account</label>
    <select id="fromAccount"></select>
    <input type="text" id="fromAccountOther" class="hidden" placeholder="Enter Platform Name" style="margin-top: 8px;">
  </div>

  <hr>
  <h3>To</h3>
  <label>Transaction Type</label>
  <select id="toType" required>
    <option value="">Select</option>
    <option>Cash</option><option>Upi</option><option>Debit</option><option>Net</option><option>Credit</option><option>Rewards</option>
  </select>

  <div id="toAccBlock" class="hidden">
    <label>Destination Account</label>
    <select id="toAccount"></select>
    <input type="text" id="toAccountOther" class="hidden" placeholder="Enter Platform Name" style="margin-top: 8px;">
  </div>

  <div id="cashBox" class="hidden">
    <label>Cash Denominations</label>
    <div id="denominations"></div>
  </div>

  <label>Total Amount</label>
  <input type="number" id="amount" step="0.01" required placeholder="0.00">

  <div class="btn-group">
    <button type="submit" id="submitBtn">Submit Transfer</button>
    <button type="button" id="btnRepeat">‚Ü∫ Repeat Last</button>
  </div>

  <div id="footerSync" class="sync-wrapper hidden">
    <div style="display: flex; gap: 8px;">
        <button type="button" id="btnSyncAll">
          <span id="syncText">‚òÅÔ∏è Sync All</span>
          <small id="syncCount">(0)</small>
        </button>
        <button type="button" id="btnStopSync" class="hidden">üõë Stop Syncing</button>
    </div>
    <button type="button" id="btnViewQueue">üìã View Pending</button>
  </div>
</form>

<div id="confirmModal" class="modal hidden">
  <div class="confirm-card">
    <h2 style="margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; font-size: 18px;">Confirm Details</h2>
    <div id="confirmDetails"></div>
    <div class="btn-group">
      <button type="button" id="btnConfirmFinal" class="btn-confirm">Process</button>
      <button type="button" id="btnConfirmCancel" class="btn-cancel">Edit</button>
    </div>
  </div>
</div>

<div id="queueModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h4 style="margin:0; font-size: 16px;">Pending Sync Queue</h4>
      <span class="close-modal" onclick="getEl('queueModal').classList.add('hidden')">&times;</span>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width:90px">Date</th>
            <th>Narration</th>
            <th style="width:140px">From</th>
            <th style="width:140px">To</th>
            <th style="width:100px">Amount</th>
            <th style="width:100px">Action</th>
          </tr>
        </thead>
        <tbody id="queueTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxTuJ83bl1akd3bP1Tujt-QxldHEwHvQZmPYefA5E6Csshxqcd3srdOLO6n-LPZbDKkoA/exec";
let isSubmitting = false, syncAborted = false, currentPayload = null, db;

const bankAccounts=["FI","HDFC Old","HDFC New","ICICI","IndusInd","Kotak","RBL","SBI"];
const creditCards=["Axis Flipkart","Axis MyZone","Axis Neo","HDFC PhonePe","HDFC Tata Neu","HDFC Millennia","HSBC","IDFC First Millenia","ICICI Amazon","ICICI Coral","ICICI Expressions","Indusind Plat Aura EDGE","Indusind Legend","Yes Finbooster","Kotak League","Kotak Image","SBI BPCL","Standard Chartered"];
const rewardPlatforms=["Amazon", "Flipkart", "Supermoney", "Payzapp", "MobiKwik", "Tata Neu"];
const denoms=[500,200,100,50,20,10,5,2,1];

const getEl = id => document.getElementById(id);
const formatDisplayDate = dStr => {
  const d = new Date(dStr);
  const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
  return `${d.getDate()}-${months[d.getMonth()]}-${d.getFullYear()}`;
};

const selfForm = getEl("form"), date = getEl("date"), narration = getEl("narration"), fromType = getEl("fromType"), fromAccount = getEl("fromAccount"), fromAccountOther = getEl("fromAccountOther"), toType = getEl("toType"), toAccount = getEl("toAccount"), toAccountOther = getEl("toAccountOther"), amount = getEl("amount"), cashBox = getEl("cashBox"), denDiv = getEl("denominations"), submitBtn = getEl("submitBtn"), batchToggle = getEl("batchToggle");
const syncCountLabel = getEl("syncCount"), btnSyncAll = getEl("btnSyncAll"), btnStopSync = getEl("btnStopSync"), footerSync = getEl("footerSync"), btnViewQueue = getEl("btnViewQueue"), queueModal = getEl("queueModal"), queueTableBody = getEl("queueTableBody");
const themeToggle = getEl("themeToggle"), statusDot = getEl("statusDot"), confirmModal = getEl("confirmModal"), confirmDetails = getEl("confirmDetails"), navFab = getEl('navFab'), fabBtn = getEl('fabToggle');

date.value = new Date().toISOString().split("T")[0];
denoms.forEach(d => { denDiv.innerHTML += `<div class="denom-card"><div class="denom-label">‚Çπ${d}</div><input type="number" value="0" data-d="${d}" placeholder="0"></div>`; });

fabBtn.onclick = e => { e.stopPropagation(); navFab.classList.toggle('active'); };
document.addEventListener('click', () => navFab.classList.remove('active'));

themeToggle.onclick = () => {
themeToggle.classList.add('theme-rotate');
      const isDark = document.body.classList.toggle("dark");
      setTimeout(() => { themeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô"; }, 150);
      setTimeout(() => themeToggle.classList.remove('theme-rotate'), 500);};

function updateStatusDot() { 
  statusDot.className = navigator.onLine ? 'online' : 'offline'; 
}
window.addEventListener('online', updateStatusDot); 
window.addEventListener('offline', updateStatusDot);
updateStatusDot();

(function initDB(){
  const req = indexedDB.open("SelfTransferDB", 1);
  req.onupgradeneeded = e => e.target.result.createObjectStore("transferQueue", { keyPath: "id", autoIncrement: true });
  req.onsuccess = e => { db = e.target.result; updatePendingCount(); };
})();

async function updatePendingCount(){
  if(!db) return;
  const tx = db.transaction("transferQueue", "readonly").objectStore("transferQueue").getAll();
  tx.onsuccess = () => {
    const items = tx.result;
    footerSync.classList.toggle("hidden", !items.length);
    syncCountLabel.textContent = `(${items.length})`;
    renderQueueTable(items);
  };
}

function buildAccounts(type, select, block, otherInput){
  select.innerHTML = "<option value=''>Select Account</option>";
  const isCash = type === "Cash" || !type;
  block.classList.toggle("hidden", isCash);
  select.required = !isCash;
  otherInput.classList.add("hidden");
  if(!isCash) {
    let list = (type === "Credit") ? creditCards : (type === "Rewards" ? rewardPlatforms : bankAccounts);
    list.forEach(v => select.add(new Option(v, v)));
    select.add(new Option("Others", "Others"));
  }
}

function calcCash(){
  let total = 0;
  document.querySelectorAll("[data-d]").forEach(i => total += Number(i.dataset.d) * Number(i.value || 0));
  if(fromType.value === "Cash" || toType.value === "Cash") amount.value = total;
}

fromType.onchange = () => { buildAccounts(fromType.value, fromAccount, getEl("fromAccBlock"), fromAccountOther); cashBox.classList.toggle("hidden", fromType.value!=="Cash" && toType.value!=="Cash"); amount.readOnly = (fromType.value==="Cash"||toType.value==="Cash"); };
toType.onchange = () => { buildAccounts(toType.value, toAccount, getEl("toAccBlock"), toAccountOther); cashBox.classList.toggle("hidden", fromType.value!=="Cash" && toType.value!=="Cash"); amount.readOnly = (fromType.value==="Cash"||toType.value==="Cash"); };
fromAccount.onchange = () => { fromAccountOther.classList.toggle('hidden', fromAccount.value !== "Others"); };
toAccount.onchange = () => { toAccountOther.classList.toggle('hidden', toAccount.value !== "Others"); };
denDiv.addEventListener("input", calcCash);

selfForm.onsubmit = async e => {
  e.preventDefault();
  selfForm.classList.add("was-validated");
  const val = parseFloat(amount.value);
  if(!selfForm.checkValidity() || isNaN(val) || val <= 0) return;
  
  const fAcc = fromType.value === "Cash" ? "Cash" : (fromAccount.value === "Others" ? fromAccountOther.value : fromAccount.value);
  const tAcc = toType.value === "Cash" ? "Cash" : (toAccount.value === "Others" ? toAccountOther.value : toAccount.value);

  currentPayload = { date: date.value, narration: narration.value, fromType: fromType.value, fromAccount: fAcc, toType: toType.value, toAccount: tAcc, amount: val, denoms: {} };
  document.querySelectorAll("[data-d]").forEach(i => currentPayload.denoms["d" + i.dataset.d] = i.value || 0);

  if (!navigator.onLine || batchToggle.checked) { saveToDB(); return; }

  let detailsHtml = `
    <div class="confirm-item"><span class="confirm-label">Date</span><span class="confirm-val">${formatDisplayDate(currentPayload.date)}</span></div>
    <div class="confirm-item"><span class="confirm-label">Narration</span><span class="confirm-val">${currentPayload.narration}</span></div>
    <div class="confirm-item"><span class="confirm-label">From</span><span class="confirm-val">${currentPayload.fromType === 'Cash' ? 'Cash' : '<strong>'+currentPayload.fromAccount+'</strong> ('+currentPayload.fromType+')'}</span></div>
    <div class="confirm-item"><span class="confirm-label">To</span><span class="confirm-val">${currentPayload.toType === 'Cash' ? 'Cash' : '<strong>'+currentPayload.toAccount+'</strong> ('+currentPayload.toType+')'}</span></div>
    <div class="confirm-item" style="border:none"><span class="confirm-label" style="color:var(--primary)">Total Amount</span><span class="confirm-val" style="color:var(--primary); font-weight:bold">‚Çπ${currentPayload.amount.toFixed(2)}</span></div>
  `;

  if(fromType.value === 'Cash' || toType.value === 'Cash') {
      detailsHtml += `<div class="confirm-section-title">Cash Matrix</div><div class="confirm-matrix">`;
      denoms.forEach(d => { detailsHtml += `<div class="matrix-card"><div class="matrix-label">‚Çπ${d}</div><strong>${currentPayload.denoms["d"+d]}</strong></div>`; });
      detailsHtml += `</div>`;
  }
  confirmDetails.innerHTML = detailsHtml;
  confirmModal.classList.remove("hidden");
};

async function executeSubmit() {
  if(!currentPayload || isSubmitting) return; 
  confirmModal.classList.add("hidden");
  isSubmitting = true; submitBtn.disabled = true; submitBtn.textContent = "Processing...";
  try { await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(currentPayload) }); alert("Saved!"); resetForm(); } 
  catch (err) { saveToDB(); alert("Saved to queue."); } 
  finally { isSubmitting = false; submitBtn.disabled = false; submitBtn.textContent = "Submit Transfer"; updatePendingCount(); }
}

function saveToDB() { if(db) { db.transaction("transferQueue", "readwrite").objectStore("transferQueue").add(currentPayload); resetForm(); updatePendingCount(); } }

async function manualSync() {
  if (!navigator.onLine) return alert("No Internet");
  if (!confirm("Sync all?")) return;
  syncAborted = false; btnSyncAll.classList.add("hidden"); btnStopSync.classList.remove("hidden");
  const items = await new Promise(res => db.transaction("transferQueue").objectStore("transferQueue").getAll().onsuccess = e => res(e.target.result));
  for (let i = 0; i < items.length; i++) {
    if (syncAborted) break;
    btnStopSync.textContent = `üõë Stop Syncing (${i+1}/${items.length})`;
    try {
      await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(items[i]) });
      await new Promise(res => db.transaction("transferQueue", "readwrite").objectStore("transferQueue").delete(items[i].id).onsuccess = res);
      updatePendingCount();
    } catch (e) { break; }
  }
  btnStopSync.classList.add("hidden"); btnSyncAll.classList.remove("hidden"); btnStopSync.textContent = "üõë Stop Syncing";
}

function renderQueueTable(items) {
  queueTableBody.innerHTML = items.length ? "" : "<tr><td colspan='6'>Queue is empty</td></tr>";
  items.forEach(item => {
    const denStr = denoms.map(v => `${v}x${item.denoms['d'+v]||0}`).join(', ');
    const fromLabel = item.fromType === 'Cash' ? `<strong>Cash</strong><br><span class="queue-denoms">${denStr}</span>` : `<strong>${item.fromAccount}</strong><br>(${item.fromType})`;
    const toLabel = item.toType === 'Cash' ? `<strong>Cash</strong><br><span class="queue-denoms">${denStr}</span>` : `<strong>${item.toAccount}</strong><br>(${item.toType})`;
    
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${formatDisplayDate(item.date)}</td><td>${item.narration}</td><td>${fromLabel}</td><td>${toLabel}</td><td>‚Çπ${item.amount.toFixed(2)}</td><td><button class="action-btn btn-edit-mini" onclick="editItem(${item.id})">‚úèÔ∏è</button><button class="action-btn btn-del-mini" onclick="deleteItem(${item.id})">üóëÔ∏è</button></td>`;
    queueTableBody.appendChild(tr);
  });
}

window.deleteItem = id => { if(confirm("Delete?")) db.transaction("transferQueue","readwrite").objectStore("transferQueue").delete(id).onsuccess = updatePendingCount; };
window.editItem = id => {
  const tx = db.transaction("transferQueue", "readonly").objectStore("transferQueue").get(id);
  tx.onsuccess = () => { loadToForm(tx.result); db.transaction("transferQueue", "readwrite").objectStore("transferQueue").delete(id).onsuccess = () => { queueModal.classList.add("hidden"); updatePendingCount(); }; };
};

function loadToForm(item){
    date.value = item.date; narration.value = item.narration;
    fromType.value = item.fromType; fromType.dispatchEvent(new Event('change'));
    if(item.fromType !== "Cash"){
        if(bankAccounts.concat(creditCards, rewardPlatforms).includes(item.fromAccount)) fromAccount.value = item.fromAccount;
        else { fromAccount.value = "Others"; fromAccount.dispatchEvent(new Event('change')); fromAccountOther.value = item.fromAccount; }
    }
    toType.value = item.toType; toType.dispatchEvent(new Event('change'));
    if(item.toType !== "Cash"){
        if(bankAccounts.concat(creditCards, rewardPlatforms).includes(item.toAccount)) toAccount.value = item.toAccount;
        else { toAccount.value = "Others"; toAccount.dispatchEvent(new Event('change')); toAccountOther.value = item.toAccount; }
    }
    if(item.fromType === "Cash" || item.toType === "Cash"){ denoms.forEach(d => { document.querySelector(`[data-d="${d}"]`).value = item.denoms["d"+d] || 0; }); calcCash(); } else amount.value = item.amount;
}

function resetForm() {
  const bState = batchToggle.checked; selfForm.reset(); selfForm.classList.remove("was-validated");
  getEl("fromAccBlock").classList.add("hidden"); getEl("toAccBlock").classList.add("hidden");
  cashBox.classList.add("hidden"); date.value = new Date().toISOString().split("T")[0];
  document.querySelectorAll("[data-d]").forEach(i => i.value = 0); batchToggle.checked = bState;
}

getEl("btnRepeat").onclick = () => { const last = JSON.parse(localStorage.getItem("lastTransfer")); if(last) loadToForm(last); };
getEl("btnConfirmFinal").onclick = executeSubmit; getEl("btnConfirmCancel").onclick = () => confirmModal.classList.add("hidden");
btnViewQueue.onclick = () => queueModal.classList.remove("hidden"); btnSyncAll.onclick = manualSync; btnStopSync.onclick = () => { syncAborted = true; };
if(localStorage.getItem("selfTransferTheme") === "dark") { 
  document.body.classList.add("dark"); 
  themeToggle.textContent = "‚òÄÔ∏è"; 
}
</script>
</body>
</html>
